---
title: "Intersection analysis of race/ethnicity and gender"
output: html_document
---

After running 08 and 09...

```{r}
articles <- read_tsv('data/pubmed/articles.tsv.xz')

pubmed_race_pmids <- 
  read_tsv('data/names/corresponding-authors.tsv.xz') %>%
  left_join(read_tsv('data/pubmed/articles.tsv.xz'), by = 'pmid') %>%
  mutate(year = substr(publication_date, 1, 4) %>% ymd(truncated = 2),
         publication_date = ymd(publication_date, truncated = 2)) %>%
  rename('surname' = last_name) %>% 
  predict_race(surname.only = T, impute.missing = F)

pubmed_race_df <- pubmed_race_pmids %>% 
  group_by(pmid, journal, publication_date, year) %>% 
  mutate(pred.whi = mean(pred.whi, na.rm = T),
            pred.bla = mean(pred.bla, na.rm = T),
            pred.asi = mean(pred.asi, na.rm = T),
            pred.his = mean(pred.his, na.rm = T),
            pred.oth = mean(pred.oth, na.rm = T)) %>% 
  ungroup()

pubmed_nat_pmids <- read_tsv('data/names/corresponding-authors.tsv.xz') %>%
  left_join(read_tsv('data/pubmed/articles.tsv.xz'), by = 'pmid') %>%
  mutate(year = substr(publication_date, 1, 4) %>% ymd(truncated = 2),
         publication_date = ymd(publication_date, truncated = 2)) %>%
  mutate(full_name = paste(fore_name, last_name)) %>% 
  left_join(nationalize_df, by = 'full_name')

pubmed_nat_df <- pubmed_nat_pmids %>% 
  group_by(pmid, journal, publication_date, year) %>% 
  summarise_at(vars(African:SouthAsian), mean, na.rm = T) %>% 
  ungroup()


pubmed_gender_race <- pubmed_gender_df %>% 
  left_join(pubmed_race_df, by = c('pmid', 'journal', 'publication_date', 'year')) %>% 
  filter(!is.na(probability_male) & !is.na(pred.whi)) %>%   
  # mutate(probability_female = 1 - probability_male,
  #        int_male_whi = probability_male*pred.whi,
  #        int_male_bla = probability_male*pred.bla,
  #        int_male_asi = probability_male*pred.asi,
  #        int_male_his = probability_male*pred.his,
  #        int_male_oth = probability_male*pred.oth,
  #        int_female_whi = 1 - int_male_whi,
  #        int_female_bla = 1 - int_male_bla,
  #        int_female_asi = 1 - int_male_asi,
  #        int_female_his = 1 - int_male_his,
  #        int_female_oth = 1 - int_male_oth)
  mutate(pred_sum_others = pred.his + pred.oth + pred.bla,
    probability_female = 1 - probability_male,
         int_male_whi = probability_male*pred.whi,
         int_male_oth = probability_male*pred_sum_others,
         int_male_asi = probability_male*pred.asi,
         int_female_whi = (1 - probability_male)*pred.whi,
         int_female_oth = (1 - probability_male)*pred_sum_others,
         int_female_asi = (1 - probability_male)*pred.asi)


pubmed_gender_nat <- pubmed_gender_df %>% 
  left_join(pubmed_nat_df, by = c('pmid', 'journal', 'publication_date', 'year')) %>% 
  filter(!is.na(probability_male) & !is.na(African)) %>% 
  mutate(OtherCategories = SouthAsian + Hispanic + Muslim + Israel + African,
         probability_female = 1 - probability_male,
         # int_male_African = probability_male*African,
         int_male_CelticEnglish = probability_male*CelticEnglish,
         int_male_European = probability_male*European,
         int_male_EastAsian = probability_male*EastAsian,
         int_male_Other = probability_male*OtherCategories,
         # int_male_Muslim = probability_male*pred.asi,
         # int_male_Hispanic = probability_male*African,
         # int_male_Israel = probability_male*pred_sum_others,
         # int_male_European = probability_male*pred.asi,
         int_female_CelticEnglish = probability_female*CelticEnglish,
         int_female_European = probability_female*European,
         int_female_EastAsian = probability_female*EastAsian,
         int_female_Other = probability_female*OtherCategories)
  
  
iscb_gender_race <- read_tsv('data/iscb/keynotes.tsv') %>%
  mutate(publication_date = ymd(year, truncated = 2),
         year = ymd(year, truncated = 2)) %>% 
  left_join(simple_fore_names, by = 'fore_name') %>% 
  left_join(gender_df, by = 'fore_name_simple') %>% 
  rename('surname' = last_name) %>% 
  predict_race(surname.only = T, impute.missing = F) %>% 
  mutate(pred_sum_others = pred.his + pred.oth + pred.bla,
    probability_female = 1 - probability_male,
         int_male_whi = probability_male*pred.whi,
         int_male_oth = probability_male*pred_sum_others,
         int_male_asi = probability_male*pred.asi,
         int_female_whi = (1 - probability_male)*pred.whi,
         int_female_oth = (1 - probability_male)*pred_sum_others,
         int_female_asi = (1 - probability_male)*pred.asi)

iscb_nat_race <- read_tsv('data/iscb/keynotes.tsv') %>%
  mutate(publication_date = ymd(year, truncated = 2),
         year = ymd(year, truncated = 2)) %>% 
  left_join(nationalize_df, by = 'full_name') %>% 
  left_join(simple_fore_names, by = 'fore_name') %>% 
  left_join(gender_df, by = 'fore_name_simple') %>% 
  mutate(OtherCategories = SouthAsian + Hispanic + Muslim + Israel + African,
         probability_female = 1 - probability_male,
         # int_male_African = probability_male*African,
         int_male_CelticEnglish = probability_male*CelticEnglish,
         int_male_European = probability_male*European,
         int_male_EastAsian = probability_male*EastAsian,
         int_male_Other = probability_male*OtherCategories,
         int_female_CelticEnglish = probability_female*CelticEnglish,
         int_female_European = probability_female*European,
         int_female_EastAsian = probability_female*EastAsian,
         int_female_Other = probability_female*OtherCategories)
my2020 <- iscb_nat_race %>% filter(year=='2020-01-01')
```


```{r}
iscb_pubmed <- iscb_gender_race %>%
  rename('journal' = conference) %>% 
  select(year, journal, contains('int'), publication_date) %>%
  mutate(type = 'Keynote speakers/Fellows') %>%
  bind_rows(
    pubmed_gender_race %>%
      select(year, journal, contains('int'), publication_date) %>%
      mutate(type = 'Pubmed authors')
  ) %>%
  pivot_longer(contains('int'),
               names_to = 'race_gender',
               values_to = 'probabilities') %>%
  group_by(type, year, publication_date, race_gender) %>%
  add_count() %>%
  mutate(
    mean_prob = mean(probabilities, na.rm = T),
    sd_prob = sd(probabilities, na.rm = T),
    n = mean(n),
    me_prob = alpha_threshold * sd_prob / sqrt(n)
  ) %>%
  ungroup() 
```


```{r}
iscb_pubmed %>%
  mutate(pop_gender = ifelse(grepl('female', race_gender), 'Female', 'Male'),
         race = case_when(
           grepl('whi', race_gender) ~ 'White',
           grepl('asi', race_gender) ~ 'Asian',
           grepl('oth', race_gender) ~ 'Other categories',
         )) %>% 
  filter(type == 'Pubmed authors') %>% 
  ggplot(aes(year, probabilities, 
             fill = fct_reorder(race, probabilities, mean) %>% fct_rev(), 
             color = fct_reorder(race, probabilities, mean) %>% fct_rev())) +
  geom_smooth(size = 0.2) +
  scale_x_date(labels = scales::date_format("%Y"),
               expand = c(0, 0),
               limits = c(ymd(start_year - 1, truncated = 2L),
                          ymd(end_year + 1, truncated = 2L))) +
  scale_fill_viridis_d(direction = -1) +
  scale_color_viridis_d(direction = -1) +
  labs(x = NULL) +
  facet_wrap(vars(pop_gender))

```



```{r}
iscb_pubmed %>%
  mutate(pop_gender = ifelse(grepl('female', race_gender), 'Female', 'Male'),
       race = case_when(
         grepl('whi', race_gender) ~ 'White',
         grepl('asi', race_gender) ~ 'Asian',
         grepl('oth', race_gender) ~ 'Other categories',
       )) %>% 
  group_by(year, type, race_gender, pop_gender, race) %>%
  summarise(mean_prob = mean(probabilities, na.rm = T)) %>%
  ungroup() %>%
    ggplot(aes(year, mean_prob, fill = race_gender)) +
    geom_bar(stat = 'identity') +
    scale_fill_viridis_d(option = 'A') +
    labs(x = NULL) +
    facet_wrap(~ type) +
    scale_x_date(
      labels = scales::date_format("%Y"),
      expand = c(0, 0),
      limits = c(
        ymd(start_year - 1, truncated = 2L),
        ymd(end_year + 1, truncated = 2L)
      )
    )
```


Who are missings?

```{r}
pubmed_gender_race_all <- pubmed_gender_df %>% 
  left_join(pubmed_race_df, by = c('pmid', 'journal', 'publication_date', 'year'))

iscb_gender_race %>% 
  filter(is.na(probability_male))

iscb_gender_race %>% 
  filter(is.na(pred.whi)) %>% 
  nrow()

pubmed_gender_race_all %>% 
  filter(is.na(probability_male)) %>% 
  select(contains('pred')) %>% 
  # group_by(year) %>% 
  colMeans(na.rm = T)

missing_gender <- pubmed_gender_race_all %>% 
  filter(is.na(probability_male)) %>% 
  select(fore_name_simple, fore_name)


pubmed_gender_race_all %>% 
  filter(is.na(probability_male), grepl('-', fore_name)) %>% 
  select(contains('pred')) %>% 
  colMeans(na.rm = T)

nchar(missing_gender$fore_name) %>% table()
m2 <- missing_gender %>% filter(nchar(fore_name) ==2)
m3 <- missing_gender %>% filter(grepl('\\.| ', fore_name))
m4 <- missing_gender %>% filter(grepl('-', fore_name))

pubmed_gender_race_all %>% 
  filter(is.na(pred.whi)) %>% 
  select(contains('male')) %>% 
  colMeans(na.rm = T)


pubmed_gender_df <- pubmed_gender_pmids %>% 
  group_by(pmid, journal, publication_date, year) %>% 
  summarise(probability_male = mean(probability_male, na.rm = T)) %>% 
  ungroup()
```



