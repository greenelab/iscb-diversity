---
title: "Visualize gender predictions based on census data"
output:
  html_document:
    theme: flatly
    code_download: true
---

## Setups

```{r message = F, warning=F}
library(tidyverse)
library(lubridate)
library(rnaturalearth)
library(wru)
source('utils/r-utils.R')
theme_set(theme_bw() + theme(legend.title = element_blank()))
```

## Load data

Only keep articles from 2002 because few authors had gender predictions before 2002.
See [093.summary-stats](docs/093.summary-stats.html) for more details.

```{r}
load('Rdata/raws.Rdata')

alpha_threshold <- qnorm(0.975)
gender_df <- read_tsv('data/gender/genderize.tsv')

pubmed_gender_df <- corr_authors %>%
  filter(year(year) >= 2002) %>% 
  left_join(gender_df, by = 'fore_name_simple')

iscb_gender_df <- keynotes %>% 
  left_join(gender_df, by = 'fore_name_simple')

start_year <- 1993
end_year <- 2019
n_years <- end_year - start_year
my_jours <- unique(pubmed_gender_df$journal)
my_confs <- unique(iscb_gender_df$conference)
n_jours <- length(my_jours)
n_confs <- length(my_confs)
```



## Prepare data frames for later analyses

- rbind results of race predictions in iscb and Pubmed
- pivot long
- compute mean, sd, marginal error

```{r}
iscb_pubmed <- iscb_gender_df %>%
  rename('journal' = conference) %>% 
  select(year, journal, probability_male, publication_date) %>%
  mutate(type = 'Keynote speakers/Fellows') %>%
  bind_rows(
    pubmed_gender_df %>%
      select(year, journal, probability_male, publication_date) %>%
      mutate(type = 'Pubmed authors')
  ) %>%
  mutate(probability_female = 1 - probability_male) %>% 
  pivot_longer(contains('probability'),
               names_to = 'gender',
               values_to = 'probabilities') %>%
  filter(!is.na(probabilities)) %>% 
  group_by(type, year, publication_date, gender) %>%
  add_count() %>%
  mutate(
    mean_prob = mean(probabilities, na.rm = T),
    sd_prob = sd(probabilities, na.rm = T),
    n = mean(n),
    me_prob = alpha_threshold * sd_prob / sqrt(n)
  ) %>%
  ungroup() 

```


### By conference keynotes/fellows
```{r}
i <- 0
iscb_gender <- vector('list', length = n_confs)

for (conf in my_confs){
  i <- i + 1
  iscb_gender[[i]] <- iscb_pubmed %>%
    filter(type != 'Pubmed authors' & journal == conf) %>%
    group_by(year, gender, journal) %>%
    summarise(mean_prob = mean(probabilities, na.rm = T), .groups = 'drop')
}
```

```{r}
save(iscb_pubmed, iscb_gender, file = 'Rdata/iscb-pubmed_gender.Rdata')
```


## Figures for paper

### Figure 1: ISCB Fellows and keynote speakers appear more evenly split between men and women than PubMed authors, but the proportion has not reached parity.

```{r fig.height=3}
fig_1 <- iscb_pubmed %>%

  group_by(year, type, gender) %>%
  summarise(mean_prob = mean(probabilities, na.rm = T), .groups = 'drop') %>%
  gender_breakdown('main', fct_rev(type))
fig_1
ggsave('figs/gender_breakdown.png', fig_1, width = 5, height = 2.5)
ggsave('figs/gender_breakdown.svg', fig_1, width = 5, height = 2.5)
```


### Supplementary Figure S1 {#sup_fig_s1}
Increasing trend of honorees who were women in each honor category, especially in the group of ISCB Fellows, which markedly increased after 2015. 

```{r warning=FALSE, message=FALSE, fig.height=3}
# By conference:
fig_1d <- bind_rows(iscb_gender) %>%
  gender_breakdown(category = 'sub', journal) +
  theme(legend.position = 'bottom')

fig_1d
ggsave('figs/fig_s1.png', fig_1d, width = 6, height = 2)
ggsave('figs/fig_s1.svg', fig_1d, width = 6, height = 2)
```


## Overview of gender prediction distribution

```{r fig.height = 3}
iscb_pubmed %>% 
  filter(gender == 'probability_male') %>% 
  ggplot(aes(x = probabilities, y = ..density.., fill = type)) +
  geom_histogram(position = 'dodge') +
  scale_fill_viridis_d(option = 'D', end = 0.8) +
  guides(label = F) +
  labs(x = 'probability_male') +
  theme(legend.position = c(0.2, 0.8))
```

## Mean and standard deviation of predicted probabilities

```{r}
ggplot(iscb_pubmed %>% filter(gender == 'probability_male'),
  aes(group = type)) +
  geom_smooth(size = 0.2, data = . %>% filter(type == 'Pubmed authors'),
              aes(x = publication_date, y = probabilities, fill = type, color = type)) +
  geom_pointrange(data = . %>% get_keynote_summary(),
                  alpha = 0.75, size = 0.3,
                  aes(x = year, y = mean_prob, shape = type,
                      ymin = mean_prob - me_prob,
                      ymax = mean_prob + me_prob)) +
  scale_y_continuous(breaks = seq(0, 1, 0.2), labels = scales::percent_format()) +
  scale_x_date(labels = scales::date_format("%Y")) +
  scale_color_viridis_d(option = 'D', begin = 0.5) +
  scale_fill_viridis_d(option = 'D', begin = 0.5) +
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = NULL, y = 'Estimated male composition') +
  theme(legend.position = c(0.2, 0.2),
        legend.margin = margin(-0.5, 0, 0, 0, unit='cm'))

```

## _P_ values for reviewers

```{r echo = F}
get_p <- function(inte, colu){
  broom::tidy(inte) %>% 
    filter(term == 'typePubmed authors') %>% 
    pull(colu) %>% 
    sprintf("%0.5g", .)
}
```

```{r}
main_lm <- lm(probabilities ~ year + type, 
     data = iscb_pubmed %>% 
       filter(gender == 'probability_female', !is.na(probabilities)) %>% 
       mutate(year = scale(year)))
summary(main_lm)
```

The two groups of scientists did not have a significant association with the gender predicted from fore names (_P_ = `r get_p(main_lm, 'p.value')`).
Interaction terms do not predict `probabilities` over and above the main effect of group of scientists and year.

```{r}
inte_lm <- lm(probabilities ~ year * type, 
   data = iscb_pubmed %>% 
     filter(gender == 'probability_female', !is.na(probabilities)) %>% 
     mutate(year = scale(year)))
summary(inte_lm)
anova(main_lm, inte_lm)
```


```{r}
sessionInfo()
```
