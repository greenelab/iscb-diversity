---
title: "Visualize nationality predictions"
output:
  html_document:
    theme: flatly
    code_download: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(rnaturalearth)
source('utils/r-utils.R')
theme_set(theme_bw() + theme(legend.title = element_blank()))
```

Only keep articles from 2002 because few authors had nationality predictions before 2002 (mostly due to missing metadata).
See [093.summary-stats](docs/093.summary-stats.html) for more details.

```{r}
alpha_threshold <- qnorm(0.975)
load('Rdata/raws.Rdata')

pubmed_nat_df <- corr_authors %>%
  filter(year(year) >= 2002) %>% 
  left_join(nationalize_df, by = c('fore_name', 'last_name')) %>%
  group_by(pmid, journal, publication_date, year) %>%
  summarise_at(vars(African:SouthAsian), mean, na.rm = T) %>%
  ungroup()

iscb_nat_df <- keynotes %>%
  left_join(nationalize_df, by = c('fore_name', 'last_name'))

start_year <- 1992
end_year <- 2019
n_years <- end_year - start_year
my_jours <- unique(pubmed_nat_df$journal)
my_confs <- unique(iscb_nat_df$conference)
n_jours <- length(my_jours)
n_confs <- length(my_confs)
region_levels <- paste(c('Celtic/English', 'European', 'East Asian', 'Hispanic', 'South Asian', 'Arabic', 'Hebrew', 'African', 'Nordic', 'Greek'), 'names')
region_levels_let <- toupper(letters[1:8])
region_cols <- c('#ffffb3', '#fccde5', '#b3de69', '#fdb462', '#80b1d3', '#8dd3c7', '#bebada', '#fb8072', '#bc80bd', '#ccebc5')
```

Names grouping:
```{r fig.height = 3}
our_country_map <- read_tsv('https://raw.githubusercontent.com/greenelab/wiki-nationality-estimate/7c22d0a5f661ce5aeb785215095deda40973ff17/data/country_to_region_NamePrism.tsv') %>%
  rename('region' = Region) %>%
  recode_region()

my_world <- ne_countries(scale='medium', returnclass = 'sf') %>%
  rename(Country = 'name') %>%
  left_join(our_country_map, by = 'Country')

(gworld <- ggplot(data = my_world) +
    geom_sf(aes(fill = fct_relevel(region, region_levels))) +
    coord_sf(crs = "+proj=eqearth +wktext") +
    scale_fill_manual(values = region_cols,
                      na.translate = FALSE) +
    theme(panel.background = element_rect(fill = "azure"),
          legend.title = element_blank(),
          legend.position = 'bottom',
          panel.border = element_rect(fill = NA)))

ggsave('figs/2020-01-31_groupings.png', gworld, width = 7, height = 4.3)
ggsave('figs/2020-01-31_groupings.svg', gworld, width = 7, height = 4.3)
```


## Descriptive statistics
Prepare data frames for later analyses:

- rbind results of race predictions in iscb and Pubmed
- pivot long
- compute mean, sd, marginal error

```{r}
iscb_pubmed_oth <- iscb_nat_df %>%
  rename('journal' = conference) %>%
  select(year, journal, African:SouthAsian, publication_date) %>%
  mutate(type = 'Keynote speakers/Fellows') %>%
  bind_rows(
    pubmed_nat_df %>%
      select(year, journal, African:SouthAsian, publication_date) %>%
      mutate(type = 'Pubmed authors')
  ) %>%
  mutate(OtherCategories = SouthAsian + Hispanic + Jewish + Muslim + Nordic + Greek + African) %>%
  pivot_longer(c(African:SouthAsian, OtherCategories),
               names_to = 'region',
               values_to = 'probabilities') %>%
  filter(!is.na(probabilities)) %>% 
  group_by(type, year, publication_date, region) %>%
  add_count() %>%
  mutate(
    mean_prob = mean(probabilities, na.rm = T),
    sd_prob = sd(probabilities, na.rm = T),
    n = mean(n),
    me_prob = alpha_threshold * sd_prob / sqrt(n)
  ) %>%
  ungroup()

iscb_pubmed <- iscb_pubmed_oth %>%
  filter(region != 'OtherCategories')
```

## Prepare data frames for analysis

### By conference keynotes/fellows
```{r fig.height=6}
i <- 0
iscb_nat <- vector('list', length = n_confs)

for (conf in my_confs){
  i <- i + 1
  iscb_nat[[i]] <- iscb_pubmed %>%
    filter(type != 'Pubmed authors' & journal == conf) %>%
    group_by(year, region, journal) %>%
    summarise(mean_prob = mean(probabilities, na.rm = T), .groups = 'drop')
}
```

```{r}
save(my_world, iscb_pubmed_oth, iscb_nat, file = 'Rdata/iscb-pubmed_nat.Rdata')
```

## Figures for paper

### Figure 4: Compared to the name collection of Pubmed authors, honorees with Celtic/English names are overrepresented while honorees with East Asian names are underrepresented.

```{r fig.height=7, fig.width=9}
fig_4a <- iscb_pubmed %>%
  filter(year < '2020-01-01') %>%
  group_by(year, type, region) %>%
  summarise(mean_prob = mean(probabilities, na.rm = T)) %>%
  ungroup() %>%
  region_breakdown('main', fct_rev(type)) +
  guides(fill = guide_legend(nrow = 2)) +
  theme(legend.position = 'bottom',
        legend.key.height = unit(3, 'mm'),
        legend.key.width = unit(3, 'mm'),
        legend.text = element_text(size = 8), 
        legend.margin = margin(-0.2, 0.2, 0.2, 0, unit='cm'))

large_regions <- c('CelticEnglish', 'EastAsian', 'European', 'OtherCategories')
## Mean and standard deviation of predicted probabilities:
fig_4b <- iscb_pubmed_oth %>%
  filter(region %in% large_regions) %>%
  # recode_region_letter() %>%
  recode_region() %>%
  loess_and_ci() +
  theme(legend.position = c(0.88, 0.83),
        legend.key.height = unit(4, 'mm'),
        legend.key.width = unit(5, 'mm'),
        legend.text = element_text(size = 6)) +
  facet_wrap(vars(fct_relevel(region, large_regions)), nrow = 1)

fig_4 <- cowplot::plot_grid(fig_4a, fig_4b, labels = 'AUTO', ncol = 1, rel_heights = c(1.3,1))
fig_4
ggsave('figs/region_breakdown.png', fig_4, width = 6.5, height = 5.5)
ggsave('figs/region_breakdown.svg', fig_4, width = 6.5, height = 5.5)
```


## _P_ values for reviewers

```{r}
inte_lm <- function(regioni){
  lm(probabilities ~ year + type, 
     data = iscb_pubmed_oth %>% 
       filter(region == regioni, !is.na(probabilities)) %>% 
       mutate(year = scale(year)))
}

inte_list <- lapply(large_regions, inte_lm)
names(inte_list) <- large_regions
lapply(inte_list, summary)
```

```{r echo = F}
get_p <- function(i, colu){
  broom::tidy(inte_list[[i]]) %>% 
    filter(term == 'typePubmed authors') %>% 
    pull(colu) %>% 
    sprintf("%0.5g", .)
}
```

## Conclusion

A name coming from the group of authors has significantly lower probability of being Celtic/English, $\beta_\textrm{Celtic/English} =$ `r get_p(1, 'estimate')` (_P_ = `r get_p(1, 'p.value')`), and higher probability of being East Asian, $\beta_\textrm{East Asian} =$ `r get_p(2, 'estimate')` (_P_ = `r get_p(2, 'p.value')`). The two groups of scientists did not have a significant association with names predicted to be European and in Other categories (_P_ = `r get_p(3, 'p.value')` and _P_ = `r get_p(4, 'p.value')`, respectively).



### Supplementary Figure S4 {#sup_fig_s4}

Proportion of authors in the Celtic English categories had decreased, particularly for papers published in Bioinformatics and BMC Bioinformatics.
ISMB keynotes had more probability attributable to Hebrew names, while RECOMB had more attributable to East Asian names.

```{r}
# fig_s4_1 <- bind_rows(pubmed_nat) %>%
#   region_breakdown(category = 'sub', journal)

fig_s4_2 <- bind_rows(iscb_nat) %>%
  filter(year < '2020-01-01') %>%
  region_breakdown(category = 'sub', journal)

# fig_s4 <- cowplot::plot_grid(fig_s4_1, fig_s4_2, labels = 'AUTO', ncol = 1)
# fig_s4
ggsave('figs/fig_s4.png', fig_s4_2, width = 6, height = 3.5)
ggsave('figs/fig_s4.svg', fig_s4_2, width = 6, height = 3.5)
```

### Supplementary Figure S5 {#sup_fig_s5}
It's difficult to come to a conclusion for other regions with so few data points and the imperfect accuracy of our prediction.
There seems to be little difference between the proportion of keynote speakers of African, Arabic, South Asian and Hispanic origin than those in the field.
However, just because a nationality isn't underrepresented against the field doesn't mean scientists from that nationality are appropriately represented.

```{r fig.height=6}
fig_s5 <- iscb_pubmed %>%
  recode_region() %>%
  loess_and_ci() +
  theme(legend.position = c(0.8, 0.1)) +
  facet_wrap(vars(fct_relevel(region, region_levels)), ncol = 3)
fig_s5
ggsave('figs/fig_s5.png', fig_s5, width = 6, height = 6)
ggsave('figs/fig_s5.svg', fig_s5, width = 6, height = 6)
```


```{r}
sessionInfo()
```
