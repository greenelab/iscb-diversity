---
title: 'Affiliation analysis'
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(rnaturalearth)
source('utils/r-utils.R')
theme_set(theme_bw() + theme(legend.title = element_blank()))
```

```{r}
world <- ne_countries(scale='medium',returnclass = 'sf') 
nat_to_reg <- world %>% 
  as_tibble() %>% 
  select(iso_a2, name, region_wb) %>% 
  rename('countries' = iso_a2,
         'country_name' = name,
         'region' = region_wb)
# region_levels <- unique(nat_to_reg$region) %>% 
#   setdiff('Antarctica')
region_levels <- c('North America', 'Europe & Central Asia', 'East Asia & Pacific', 'Latin America & Caribbean', 'South Asia', 'Middle East & North Africa', 'Sub-Saharan Africa')
```

```{r}
all_full_names <- read_tsv('data/names/full-names.tsv.xz')

alpha_threshold <- qnorm(0.975)

pubmed_aff_pmids <- read_tsv('data/names/corresponding-authors.tsv.xz') %>%
  left_join(read_tsv('data/pubmed/articles.tsv.xz'), by = 'pmid') %>%
  mutate(year = substr(publication_date, 1, 4) %>% ymd(truncated = 2),
         publication_date = ymd(publication_date, truncated = 2)) 

pubmed_aff_df <- pubmed_aff_pmids %>%
  filter(!is.na(countries)) %>% # a paper has two corresponding authors, one does not have affiliations. Should we remove this author and give the other the full weight (1) on the paper?
  add_count(pmid, name = 'num_corr_authors') %>% # number of corresponding authors per pmid
  select(pmid, journal, publication_date, year, countries, fore_name_simple, last_name_simple, num_corr_authors) %>%
  separate_rows(countries) %>%
  add_count(pmid, fore_name_simple, last_name_simple, name = 'num_affls') %>% # number of country affiliations per author
  mutate(probabilities = 1 / num_corr_authors / num_affls) %>%
  left_join(nat_to_reg, by = 'countries') %>%
  filter(!is.na(country_name)) %>%
  mutate(row = row_number()) %>%
  pivot_wider(
    names_from = region,
    values_from = probabilities,
    values_fill = list(probabilities = 0)
  ) %>%
  select(-row) %>% 
  group_by(pmid) %>% 
  mutate_at(region_levels, sum) %>% 
  ungroup() %>% 
  distinct(pmid, .keep_all = T) %>% 
  mutate(`Other Categories` = `South Asia` + `Latin America & Caribbean` + `Middle East & North Africa` + `Sub-Saharan Africa`) %>%
  select(-c(countries, country_name, num_affls)) %>% 
  pivot_longer(c(region_levels, `Other Categories`),
               names_to = 'region',
               values_to = 'probabilities')


iscb_aff_df <- read_tsv('data/iscb/keynotes.tsv') %>%
  separate_rows(afflcountries, sep = '\\|') %>% 
  add_count(year, conference, full_name, name = 'num_affls') %>%
  mutate(probabilities = 1 / num_affls,
         publication_date = ymd(year, truncated = 2),
         year = ymd(year, truncated = 2)) %>%
  left_join(nat_to_reg, by = c('afflcountries' = 'country_name')) %>%
  filter(!is.na(afflcountries)) %>%
  pivot_wider(
    names_from = region,
    values_from = probabilities,
    values_fill = list(probabilities = 0)
  ) %>% 
  group_by(year, conference, full_name) %>% 
  mutate_at(vars(`North America`:`East Asia & Pacific`), sum) %>% 
  ungroup() %>% 
  distinct(year, conference, full_name, .keep_all = T) %>% 
  mutate(`Other Categories` = `Latin America & Caribbean` + `Middle East & North Africa`) %>%
  pivot_longer(c(`North America`:`East Asia & Pacific`, `Other Categories`),
               names_to = 'region',
               values_to = 'probabilities')

start_year <- 1997
end_year <- 2019
n_years <- end_year - start_year
my_jours <- unique(pubmed_aff_df$journal)
my_confs <- unique(iscb_aff_df$conference)
n_jours <- length(my_jours)
n_confs <- length(my_confs)

region_levels_let <- toupper(letters[1:8])
```

## Missing data

```{r}
# iscb_aff_df %>% filter(is.na(countries))
pubmed_aff_pmids %>% filter(is.na(countries))
sum(is.na(pubmed_aff_pmids$countries))
sum(is.na(pubmed_aff_df$countries))

```


## Descriptive statistics
Prepare data frames for later analyses:

- rbind results of race predictions in iscb and Pubmed
- pivot long
- compute mean, sd, marginal error

```{r}
iscb_pubmed_oth <- iscb_aff_df %>%
  rename('journal' = conference) %>%
  select(year, journal, publication_date, probabilities, region) %>%
  mutate(type = 'Keynote speakers/Fellows') %>%
  bind_rows(
    pubmed_aff_df %>%
      select(year, journal, publication_date, probabilities, region) %>%
      mutate(type = 'Pubmed authors')
  ) %>%
  group_by(type, year, publication_date, region) %>%
  add_count() %>%
  mutate(
    mean_prob = mean(probabilities, na.rm = T),
    sd_prob = sd(probabilities, na.rm = T),
    n = mean(n),
    me_prob = alpha_threshold * sd_prob / sqrt(n)
  ) %>%
  ungroup()

iscb_pubmed <- iscb_pubmed_oth %>%
  filter(region != 'Other Categories')
```

## Prepare data frames for analysis
### By journals

```{r}
pubmed_aff <- vector('list', length = n_jours)
i <- 0

for (jour in my_jours){
  i <- i + 1
  pubmed_aff[[i]] <- iscb_pubmed %>%
    filter(type == 'Pubmed authors' & journal == jour) %>%
    group_by(year, region, journal) %>%
    summarise(mean_prob = mean(probabilities, na.rm = T)) %>%
    ungroup()
}
```



### By conference keynotes/fellows
```{r fig.height=6}
i <- 0
iscb_aff <- vector('list', length = n_confs)

for (conf in my_confs){
  i <- i + 1
  iscb_aff[[i]] <- iscb_pubmed %>%
    filter(type != 'Pubmed authors' & journal == conf) %>%
    group_by(year, region, journal) %>%
    summarise(mean_prob = mean(probabilities, na.rm = T)) %>%
    ungroup()
}
```

## Figures for paper

### Figure 6: Compared to the name collection of Pubmed authors, honorees from North America are overrepresented while Europe & Central Asia and East Asia & Pacific honorees are underrepresented.

```{r fig.height=7, fig.width=9}
fig_5a <- iscb_pubmed %>%
  filter(year < '2020-01-01') %>%
  group_by(year, type, region) %>%
  summarise(mean_prob = mean(probabilities, na.rm = T)) %>%
  ungroup() %>%
  affiliation_breakdown('main', fct_rev(type)) +
  guides(fill = guide_legend(nrow = 2)) +
  theme(legend.position = 'bottom',
        legend.key.height = unit(3, 'mm'),
        legend.key.width = unit(3, 'mm'),
        legend.text = element_text(size = 8),
        legend.margin = margin(-0.2, 0.2, 0.2, 0, unit='cm'))

big_cat <- c('North America', 'Europe & Central Asia', 'East Asia & Pacific', 'Other Categories')
## Mean and standard deviation of predicted probabilities:
fig_5b <- iscb_pubmed_oth %>%
  filter((region %in% big_cat)) %>%
  loess_and_ci() +
  theme(legend.position = c(0.88, 0.83),
        legend.key.height = unit(4, 'mm'),
        legend.key.width = unit(5, 'mm'),
        legend.text = element_text(size = 6)) +
  facet_wrap(vars(fct_relevel(region, big_cat)), nrow = 1)

fig_5 <- cowplot::plot_grid(fig_5a, fig_5b, labels = 'AUTO', ncol = 1, rel_heights = c(1.3,1))
fig_5
ggsave('figs/geo_affiliation_breakdown.png', fig_5, width = 6.5, height = 5.5)

```

### Supplementary Figure S6 {#sup_fig_s6}

Proportion of authors from East Asia & Pacific had increased, particularly for papers published in Bioinformatics and BMC Bioinformatics.

```{r fig.width=6, fig.height=3.5}
fig_s6_1 <- bind_rows(pubmed_aff) %>%
  affiliation_breakdown(category = 'sub', journal) +
  theme(legend.position = 'right',
        legend.key.height = unit(3.5, 'mm'),
        legend.key.width = unit(2, 'mm'),
        legend.text = element_text(size = 7),
        legend.margin = margin(0, -0.03, 0, -0.2, unit='cm')
        )

  fig_s6_2 <- bind_rows(iscb_aff) %>%
  filter(year < '2020-01-01') %>%
  affiliation_breakdown(category = 'sub', journal)

fig_s6 <- cowplot::plot_grid(fig_s6_1, fig_s6_2, labels = 'AUTO', ncol = 1, rel_widths = 2)
fig_s6
ggsave('figs/fig_s6.png', fig_s6, width = 6, height = 3.5)
```

### Supplementary Figure S7 {#sup_fig_s7}

```{r fig.height=4, fig.width=7}
fig_s7 <- iscb_pubmed %>%
  loess_and_ci() +
  theme(legend.position = c(0.88, 0.25), legend.text = element_text(size = 7)) +
  facet_wrap(vars(fct_relevel(region, region_levels)), nrow = 2)
fig_s7
ggsave('figs/fig_s7.png', fig_s7, width = 7, height = 3.5)

```


## Country level
### Table of representations

Observed vs. expected

```{r}
iscb_aff_country <- read_tsv('data/iscb/keynotes.tsv') %>%
  separate_rows(afflcountries, sep = '\\|') %>% 
  filter(!is.na(afflcountries)) %>% 
  add_count(year, conference, full_name, name = 'num_affls') %>%
  mutate(probabilities = 1 / num_affls,
         publication_date = ymd(year, truncated = 2),
         year = ymd(year, truncated = 2)) %>%
  left_join(nat_to_reg, by = c('afflcountries' = 'country_name'))

pubmed_aff_country <- pubmed_aff_pmids %>%
  filter(!is.na(countries)) %>% 
  add_count(pmid, name = 'num_corr_authors') %>% # number of corresponding authors per pmid
  select(pmid, journal, publication_date, year, countries, fore_name_simple, last_name_simple, num_corr_authors) %>%
  separate_rows(countries) %>%
  add_count(pmid, fore_name_simple, last_name_simple, name = 'num_affls') %>% 
  mutate(probabilities = 1 / num_corr_authors / num_affls) 

country_rep <- iscb_aff_country %>% 
  group_by(countries) %>% 
  summarise(Observed = sum(probabilities)) %>% 
  arrange(desc(Observed))

# check = pubmed_aff_pmids %>% filter(pmid == 30908487)
num_papers <- pubmed_aff_pmids %>% 
  filter(!is.na(countries)) %>% 
  pull(pmid) %>% 
  unique() %>% 
  length()

num_honorees <- iscb_aff_country$probabilities %>% 
  sum()

obs_vs_exp_all <- pubmed_aff_country %>%
  group_by(countries) %>%
  summarise(num_authors = sum(probabilities)) %>%
  ungroup() %>% 
  mutate(freq_affi = num_authors / sum(num_authors)) %>%
  arrange(desc(num_authors)) %>%
  mutate(Expected = round(freq_affi * sum(country_rep$Observed), 1)) %>%
  left_join(country_rep, by = 'countries') %>%
  left_join(nat_to_reg, by = 'countries') %>%
  select(country_name, everything()) %>%
  select(-c(region, freq_affi, countries)) %>%
  mutate(
    Observed = replace_na(Observed, 0),
    over_rep = Observed - Expected,
    other_honorees = num_honorees - Observed,
    other_authors = num_papers - num_authors,
    presentation = ifelse(over_rep > 0, "#377EB8", "#E41A1C")
  )
print(obs_vs_exp_all)
```



### Fisher exact test
Null hypothesis: For each country, the proportion of honorees affiliated with an institution/company from that country is similar to the proportion of authors affiliated with an institution/company from that country.

```{r warning=FALSE, fig.width = 7, fig.height = 2.5}
my_fish <- function(df) {
  res <- df %>%
    unlist() %>%
    matrix(ncol = 2) %>%
    fisher.test()
  
  data_frame(odds_ratio = res$estimate,
             lower_bound = res$conf.int[1],
             upper_bound = res$conf.int[2],
             p_value = res$p.value)
}

nested_obs_exp <- obs_vs_exp_all %>%
  filter(!is.na(country_name)) %>% 
  select(country_name, Observed, other_honorees, num_authors, other_authors) %>% 
  group_by(country_name) %>% 
  nest() 

fish_obs_exp <- nested_obs_exp %>% 
  mutate(fish = map(data, my_fish)) %>% 
  dplyr::select(-data) %>% 
  unnest() %>% 
  mutate(log_lower = log2(lower_bound))

enrich_df <- world %>% 
  left_join(fish_obs_exp, by = c('name' = 'country_name'))

enrich_df %>% 
  ggplot() +
  geom_sf(aes(fill = log_lower)) +
  scale_fill_gradientn(
    colours = c("#3CBC75FF","white","#440154FF"),
    na.value = NA,
    values = scales::rescale(
      c(min(enrich_df %>% filter(!is.infinite(log_lower)) %>% pull(log_lower), na.rm = T),
        0,
        max(enrich_df$log_lower, na.rm = T)))
  )
```

Presentation of countries that have discrepancies of at least 3 honorees (in either direction):

```{r fig.width = 7, fig.height = 3.5}
filtered_obs_exp <- obs_vs_exp_all %>% 
  left_join(fish_obs_exp, by = 'country_name') %>% 
  filter(abs(over_rep) >= 3) %>% 
  mutate(distance_to_null = case_when(
    lower_bound > 1 ~ lower_bound - 1,
    TRUE ~ upper_bound - 1
  ),
    country_name = as.factor(country_name) %>% fct_reorder(distance_to_null)) %>% 
  arrange(desc(distance_to_null))

plot_obs_exp <- filtered_obs_exp %>%
  mutate(nodds_ratio = - odds_ratio,
         nlower_bound = - lower_bound, 
         nupper_bound = - upper_bound) %>% 
  select(country_name, Expected, Observed, nodds_ratio, nlower_bound, nupper_bound, presentation) %>% 
  pivot_longer(- c(country_name, presentation), names_to = 'type') %>% 
  mutate(subtype = ifelse(type == 'Expected' | type == 'Observed', 'Number of honorees', '_Odds ratio, 95% CI')) 

plot_obs_exp_right <- plot_obs_exp %>% filter(subtype == 'Number of honorees')
plot_obs_exp_left <- plot_obs_exp %>% filter(subtype != 'Number of honorees')

odds_plot <- plot_obs_exp_right %>%
  ggplot(aes(x = country_name)) +
  geom_point(aes(y = value, group = type, color = type, shape = type)) +
  geom_line(aes(y = value, group = type, color = type)) +
  ggpol::facet_share( ~ subtype,  scales = "free", reverse_num = T) +
  coord_flip() +
  labs(x = NULL, y = NULL) +
  theme(
    legend.position = 'None',
    panel.grid.minor = element_blank(),
    axis.text.y = element_text(color = rev(filtered_obs_exp$presentation))
  ) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  geom_pointrange(
    data = plot_obs_exp_left %>%
      pivot_wider(names_from = type),
    aes(y = nodds_ratio,
        ymin = nlower_bound,
        ymax = nupper_bound,
        group = country_name),
    color = filtered_obs_exp$presentation,
    stroke = 0.3
  ) +
  geom_hline(data = plot_obs_exp_left, aes(yintercept = -1), linetype = 2) +
  ggrepel::geom_text_repel(data = . %>% filter(country_name == 'United States'),
                              nudge_y = 0, nudge_x = -1, segment.alpha = 0.5, #box.padding = 0.1,
                              aes(y = value, label = type, color = type)) +
  theme(plot.margin = margin(0.4,0.4,0.4, -1.5, "cm"))
odds_plot
ggsave('figs/odds-plot.png', odds_plot, width = 7, height = 3.5)

```


```{r}
sessionInfo()
```

