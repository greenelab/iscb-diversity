---
title: 'Affiliation analysis'
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(rnaturalearth)
source('utils/r-utils.R')
library(DT)
theme_set(
  theme_bw() + 
    theme(
      panel.grid.minor = element_blank(),
      panel.grid.major.y = element_blank(),
      legend.title = element_blank()
    ))
```


```{r}
all_full_names <- read_tsv('data/names/full-names.tsv.xz')

pubmed_aff_pmids <- read_tsv('data/names/corresponding-authors.tsv.xz') %>%
  left_join(read_tsv('data/pubmed/articles.tsv.xz'), by = 'pmid') %>%
  mutate(year = substr(publication_date, 1, 4) %>% ymd(truncated = 2),
         publication_date = ymd(publication_date, truncated = 2))

world <- ne_countries(scale='medium',returnclass = 'sf') 
nat_to_reg <- world %>% 
  as_tibble() %>% 
  select(iso_a2, name, region_wb) %>% 
  rename('countries' = iso_a2,
         'country_name' = name,
         'region' = region_wb)
```

## Country level analysis

Observed vs. expected

```{r}
iscb_aff_country <- read_tsv('data/iscb/keynotes.tsv') %>%
  separate_rows(afflcountries, sep = '\\|') %>% 
  filter(!is.na(afflcountries)) %>% 
  add_count(year, conference, full_name, name = 'num_affls') %>%
  mutate(probabilities = 1 / num_affls,
         publication_date = ymd(year, truncated = 2),
         year = ymd(year, truncated = 2)) %>%
  left_join(nat_to_reg, by = c('afflcountries' = 'country_name')) %>% 
  filter(conference != 'PSB') # remove PSB

pubmed_aff_country <- pubmed_aff_pmids %>%
  filter(!is.na(countries)) %>% 
  add_count(pmid, name = 'num_corr_authors') %>% # number of corresponding authors per pmid
  select(pmid, journal, publication_date, year, countries, fore_name_simple, last_name_simple, num_corr_authors) %>%
  separate_rows(countries) %>%
  add_count(pmid, fore_name_simple, last_name_simple, name = 'num_affls') %>% 
  mutate(probabilities = 1 / num_corr_authors / num_affls) 

country_rep <- iscb_aff_country %>% 
  group_by(countries) %>% 
  summarise(Observed = sum(probabilities)) %>% 
  arrange(desc(Observed))

num_papers <- pubmed_aff_pmids %>% 
  filter(!is.na(countries)) %>% 
  pull(pmid) %>% 
  unique() %>% 
  length()

num_honorees <- sum(iscb_aff_country$probabilities)

obs_vs_exp_all <- pubmed_aff_country %>%
  group_by(countries) %>%
  summarise(num_authors = sum(probabilities)) %>%
  ungroup() %>% 
  mutate(freq_affi = num_authors / sum(num_authors)) %>%
  arrange(desc(num_authors)) %>%
  mutate(Expected = freq_affi * num_honorees) %>%
  left_join(country_rep, by = 'countries') %>%
  left_join(nat_to_reg, by = 'countries') %>%
  select(country_name, everything()) %>%
  select(-c(region, countries)) %>%
  mutate(
    Observed = replace_na(Observed, 0),
    over_rep = Observed - Expected,
    other_honorees = num_honorees - Observed,
    other_authors = num_papers - num_authors
  )
```

### Fisher's exact test and 
#### Table of representations
Null hypothesis: For each country, the proportion of honorees affiliated with an institution/company from that country is similar to the proportion of authors affiliated with an institution/company from that country.

```{r warning=FALSE, fig.width = 7*1.5, fig.height = 2.5*1.5}
my_fish <- function(df) {
  res <- df %>%
    unlist() %>%
    matrix(ncol = 2) %>%
    fisher.test()
  
  data_frame(odds_ratio = res$estimate,
             lower_bound = res$conf.int[1],
             upper_bound = res$conf.int[2],
             p_value = res$p.value)
}

nested_obs_exp <- obs_vs_exp_all %>%
  filter(!is.na(country_name)) %>% 
  select(country_name, Observed, other_honorees, num_authors, other_authors) %>% 
  group_by(country_name) %>% 
  nest() 

fish_obs_exp <- nested_obs_exp %>% 
  mutate(fish = map(data, my_fish)) %>% 
  dplyr::select(-data) %>% 
  unnest()


fish_obs_exp %>% 
  mutate(ci = paste0('(', round(log2(lower_bound), 1), ', ', 
                     round(log2(upper_bound), 1), ')'),
         lodds_ratio = log2(odds_ratio)) %>% 
  left_join(obs_vs_exp_all, by = 'country_name') %>% 
  select(country_name, freq_affi, Observed, Expected, over_rep, 
         # log2fc, 
         lodds_ratio, ci) %>% 
  rename('Country' = 'country_name',
         'Author proportion' = 'freq_affi',
         'Observed - Expected' = 'over_rep',
         'Log2(odds ratio)' = 'lodds_ratio',
         '95% Confidence interval' = 'ci') %>% 
  datatable() %>% 
  formatPercentage('Author proportion', 2) %>% 
  formatRound(c('Observed', 'Expected', 'Observed - Expected', 'Log2(odds ratio)'), 1)
```


```{r include = F, eval = F, fig.width = 7*1.5, fig.height = 2.5*1.5}
# world map of enrichment
enrich_df <- world %>% 
  left_join(
    fish_obs_exp  %>% 
      mutate(log_lower = case_when(
        lower_bound > 1 ~ log2(lower_bound),
        upper_bound < 1 ~ log2(upper_bound),
        TRUE ~ 0)
      ), by = c('name' = 'country_name'))

odds_map <- enrich_df %>% 
  ggplot() +
  geom_sf(aes(fill = log_lower)) +
  scale_fill_gradientn(
    colours = c('#3CBC75FF','white','#440154FF'),
    na.value = NA,
    values = scales::rescale(
      c(min(enrich_df$log_lower, na.rm = T),
        0,
        max(enrich_df$log_lower, na.rm = T)))
  ) +
  coord_sf(crs = '+proj=eqearth +wktext')
odds_map
ggsave('figs/odds-map.png', odds_map, width = 7, height = 2.5)
# equal earth map projection:
# http://equal-earth.com/equal-earth-projection.html
```

#### Figure of representations
Presentation of 20 countries that have the most publications.

```{r fig.width = 7, fig.height = 3.5}
filtered_obs_exp <- obs_vs_exp_all %>% 
  left_join(fish_obs_exp, by = 'country_name') %>% 
  top_n(20, num_authors) %>% 
  mutate(
    distance_to_null = case_when(
      lower_bound > 1 ~ lower_bound - 1,
      TRUE ~ upper_bound - 2
    ),
    presentation = case_when(
      lower_bound > 1 ~ '#377EB8', 
      upper_bound < 1 ~ '#E41A1C',
      TRUE ~ 'grey20'
    ),
    country_name =  as.factor(country_name) %>% fct_reorder(num_authors)) %>% 
  arrange(desc(num_authors))

plot_obs_exp <- filtered_obs_exp %>%
  mutate(lodds_ratio = log2(odds_ratio),
         llower_bound = log2(lower_bound), 
         lupper_bound = log2(upper_bound)) %>% 
  select(country_name, Expected, Observed, lodds_ratio, llower_bound, lupper_bound, presentation, over_rep) %>% 
  pivot_longer(- c(country_name, presentation, over_rep), names_to = 'type') %>% 
  mutate(subtype = ifelse(type == 'Expected' | type == 'Observed', 'Sqrt(number of honorees)', 'Log2 odds ratio, 95% CI')) 

```


```{r}
plot_obs_exp_right <- plot_obs_exp %>% filter(subtype == 'Sqrt(number of honorees)')
plot_obs_exp_left <- plot_obs_exp %>% filter(subtype != 'Sqrt(number of honorees)')

odds_plot_left <- plot_obs_exp_left %>%
  ggplot(aes(x = country_name)) +
  coord_flip() +
  labs(x = NULL, y = bquote(Log[2] ~ 'odds ratio, 95% CI')) +
  theme(
    legend.position = c(0.9, 0.3),
    axis.text.x = element_text(color = rev(plot_obs_exp_left$presentation)),
    plot.margin = margin(5.5, 2, 5.5, 5.5, unit = 'pt')
  ) +
  scale_color_brewer(type = 'qual', palette = 'Set1') +
  geom_pointrange(
    data = plot_obs_exp_left %>%
      pivot_wider(names_from = type),
    aes(y = lodds_ratio,
        ymin = llower_bound,
        ymax = lupper_bound,
        group = country_name),
    color = filtered_obs_exp$presentation,
    stroke = 0.3
  ) +
  scale_x_discrete(position = 'top', labels = NULL) +
  scale_y_reverse() +
  geom_hline(data = plot_obs_exp_left, aes(yintercept = 0), linetype = 2)

odds_plot_right <- plot_obs_exp_right %>%
  ggplot(aes(x = country_name, y = value)) +
  geom_line(aes(group = country_name),
            color = rev(plot_obs_exp_right$presentation)) +
  geom_point(aes(shape = type), color = 'grey40') +
  labs(x = NULL, y = 'Number of honorees') +
  theme(
    legend.position = c(0.75 , 0.3),
    axis.text.y = element_text(
      color = rev(filtered_obs_exp$presentation),
      hjust = 0.5),
    plot.margin = margin(5.5, 5.5, 8.5, 2, unit = 'pt')
  ) +
  scale_y_sqrt(breaks = c(0, 1, 4, 16, 50, 120, 225)) +
  # scale_color_brewer(type = 'qual', palette = 'Set1') +
  coord_flip() +
  geom_text(
    data = . %>% 
      filter(type == 'Expected' & !(country_name %in% c('Israel', 'United States'))),
    nudge_y = 1.2, aes(label = round(over_rep, 1)), color = 'grey20', size = 2.5) +
  geom_text(
    data = . %>% 
      filter(type == 'Expected' & country_name %in% c('Israel', 'United States')), 
    nudge_y = -1.2, aes(label = round(over_rep, 1)), color = 'grey20', size = 2.5)

odds_plot <- cowplot::plot_grid(odds_plot_left, odds_plot_right,
                                rel_widths = c(1, 1.3))
odds_plot
ggsave('figs/odds-plot.png', odds_plot, width = 5.5, height = 3.5)

```


```{r}
sessionInfo()
```

