---
title: "Representation analysis of race/ethnicity in the US"
output:
  html_document:
    theme: flatly
    code_download: true
---


```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(broom)
library(lubridate)
library(forcats)

source('utils/r-utils.R')
library(wru)
theme_set(
  theme_bw() + 
    theme(panel.grid.minor = element_blank(),
          legend.title = element_blank()))

alpha_threshold <- qnorm(0.975)
start_year <- '1993-01-01'
end_year <- '2019-12-31'
n_years <- year(end_year) - year(start_year)

race_levels <- c('White', 'Asian', 'Black', 'Hispanic', 'Other', 'Other categories')
```


```{r}
all_full_names <- readr::read_tsv('data/names/full-names.tsv.xz') %>% distinct()
world <- rnaturalearth::ne_countries(scale='medium',returnclass = 'sf') 
nat_to_reg <- world %>% 
  as_tibble() %>% 
  select(iso_a2, name, region_wb) %>% 
  rename('countries' = iso_a2,
         'country_name' = name,
         'region' = region_wb)
articles <- readr::read_tsv('data/pubmed/articles.tsv.xz')

# looking at only US affiliation
pubmed_aff_pmids <- readr::read_tsv('data/names/corresponding-authors.tsv.xz',
                             col_types = readr::cols(fore_name_simple = readr::col_character())) %>%
  left_join(articles, by = 'pmid') %>%
  mutate(year = substr(publication_date, 1, 4) %>% ymd(truncated = 2),
         publication_date = ymd(publication_date, truncated = 2)) %>% 
  filter(year(publication_date) < 2020) %>% 
  tidyr::separate_rows(countries, sep = ',') %>% 
  filter(countries == 'US')
  
pubmed_race_pmids <- pubmed_aff_pmids %>%
  rename('surname' = last_name_simple) %>% 
  predict_race(surname.only = T, impute.missing = F) 

pubmed_us_race <- pubmed_race_pmids %>% 
  group_by(pmid, journal, publication_date, year) %>% 
  summarise_at(vars(contains('pred.')), mean, na.rm = T) %>% 
  ungroup() %>%
  {.}

iscb_us_race <- readr::read_tsv('data/iscb/keynotes.tsv') %>%
  mutate(publication_date = ymd(year, truncated = 2),
         year = ymd(year, truncated = 2)) %>% 
  tidyr::separate_rows(afflcountries, sep = '\\|') %>% 
  filter(afflcountries == 'United States') %>% 
  left_join(all_full_names, by = c('fore_name', 'last_name')) %>%
  rename('surname' = last_name_simple) %>%
  predict_race(surname.only = T, impute.missing = F) %>% 
  filter(conference != 'PSB', year != '2020-01-01') 
  # remove PSB, exclude ISCB Fellows and ISMB speakers in 2020 for now

my_jours <- unique(pubmed_us_race$journal)
my_confs <- unique(iscb_us_race$conference)
n_jours <- length(my_jours)
n_confs <- length(my_confs)
```

Missing data:
```{r}
iscb_us_race %>% filter(is.na(pred.whi)) %>% nrow()
iscb_us_race %>% nrow()
# pubmed_us_race %>% filter(is.na(simple_last_name)) %>% nrow()
pubmed_race_pmids %>% filter(is.na(pred.whi)) %>% nrow()
pubmed_race_pmids %>% filter(is.na(surname)) %>% nrow()
```


```{r}
iscb_pubmed <- iscb_us_race %>%
  rename('journal' = conference) %>% 
  select(year, journal, contains('pred')) %>%
  mutate(publication_date = year,
         type = 'Keynote speakers/Fellows') %>%
  bind_rows(
    pubmed_us_race %>%
      select(year, journal, contains('pred'), publication_date) %>%
      mutate(type = 'Pubmed authors')
  ) %>%
  mutate(pred_sum_others = pred.his + pred.oth + pred.bla) %>% 
  tidyr::pivot_longer(contains('pred'),
               names_to = 'Race',
               values_to = 'probabilities') %>%
  filter(!is.na(probabilities)) %>% 
  recode_race() %>%
  group_by(type, year, publication_date, Race) %>%
  add_count() %>%
  mutate(
    mean_prob = mean(probabilities, na.rm = T),
    sd_prob = sd(probabilities, na.rm = T),
    n = mean(n),
    me_prob = alpha_threshold * sd_prob / sqrt(n)
  ) %>%
  ungroup() 
```


10 journals with the most computational biology articles:

```{r}
large_jours <- articles %>%
  count(journal, sort = T) %>% 
  head(10)

articles %>% 
  mutate(publication_date = ymd(publication_date, truncated = 2)) %>% 
  select(publication_date, journal) %>% 
  filter(journal %in% large_jours$journal) %>% 
  ggplot(aes(x = publication_date, fill = forcats::fct_infreq(journal))) +
  geom_histogram(size = 0, bins = 27) +
  scale_fill_brewer(palette = 'Set3') +
  theme(legend.position = c(0.2, 0.7)) +
  labs(x = NULL, y = NULL) +
scale_x_date(
    labels = scales::date_format("%Y"),
    breaks = as.Date(c('2000-01-01', '2010-01-01', '2019-01-01')),
    limits = c(as.Date('1993-01-01'), as.Date('2019-12-31'))) + 
  # geom_text(data = jours, aes(x = x, y = y, label = label), color = 'grey10') +
  NULL
```

```{r}
pubmed_race <- vector('list', length = n_jours)
i <- 0
for (jour in large_jours$journal){
  i <- i + 1
  pubmed_race[[i]] <- iscb_pubmed %>%
    filter(type == 'Pubmed authors' & journal == jour & (Race != 'Other categories')) %>%
    group_by(year, Race, journal) %>%
    summarise(mean_prob = mean(probabilities, na.rm = T), .groups = 'drop') %>%
    # ungroup() %>% 
    {.}
}

iscb_race <- vector('list', length = n_confs)
i <- 0
for (conf in my_confs){
  i <- i + 1
  iscb_race[[i]] <- iscb_pubmed %>%
    filter(type != 'Pubmed authors' & journal == conf & (Race != 'Other categories')) %>%
    group_by(year, Race, journal) %>%
    summarise(mean_prob = mean(probabilities, na.rm = T), .groups = 'drop') %>%
    # ungroup() %>% 
    {.}
}
```

```{r}
save(iscb_pubmed, pubmed_race, iscb_race, file = 'Rdata/iscb-pubmed_us-race.Rdata')
```

```{r fig.height=7}
fig_stats <- iscb_pubmed %>% 
  filter(Race %in% c('White', 'Asian', 'Other categories')) %>% 
  loess_and_ci(start_y = '1992-01-01', end_y = end_year) +
  theme(legend.position = c(0.84, 0.78)) +
  facet_wrap(vars(forcats::fct_rev(Race)))

fig_2a <- iscb_pubmed %>%
  filter(Race != 'Other categories'
         # ,
         # type == 'Pubmed authors'
         ) %>%
  group_by(year, type, Race) %>%
  summarise(mean_prob = mean(probabilities, na.rm = T), .groups = 'drop') %>%
  race_breakdown(category = 'main', type)

fig_2 <- cowplot::plot_grid(fig_2a, fig_stats, labels = c('', 'E'), ncol = 1
                            , rel_heights = c(1.5,1))
fig_2

ggsave('figs/us_racial_makeup.png', fig_2, width = 6.5, height = 5.5)
ggsave('figs/us_racial_makeup.svg', fig_2, width = 6.5, height = 5.5)
```

### What about p-values?

Regression of the probability of a name of a certain race on the type of scientists (authors vs. speakers) and year (interaction term included):

```{r}
main_lm <- function(racei){
  lm(probabilities ~ year + type, 
     data = iscb_pubmed %>% 
       filter(Race == racei, !is.na(probabilities)) %>% 
       mutate(year = scale(year)))
}
inte_lm <- function(racei){
  lm(probabilities ~ year * type, 
     data = iscb_pubmed %>% 
       filter(Race == racei, !is.na(probabilities)) %>% 
       mutate(year = scale(year)))
}
inte_list <- lapply(c('White', 'Asian', 'Other categories'), main_lm)
lapply(inte_list, summary)
```

```{r echo = F}
get_p <- function(i, colu){
  tidy(inte_list[[i]]) %>% 
    filter(term == 'typePubmed authors') %>% 
    pull(colu) %>% 
    sprintf("%0.5f", .)
}
```

### Should we include interaction terms?

Interaction terms do not predict `probabilities` over and above the main effect of group of scientists and year.
```{r}
compare_lm <- function(racei) anova(main_lm(racei), inte_lm(racei))
lapply(c('White', 'Asian', 'Other categories'), compare_lm)
```

## Conclusion

A name coming from the group of authors has significantly lower probability of being white, $\beta_\textrm{white} =$ `r get_p(1, 'estimate')` (_P_ = `r get_p(1, 'p.value')`), and higher probability of being Asian, $\beta_\textrm{Asian} =$ `r get_p(2, 'estimate')` (_P_ = `r get_p(2, 'p.value')`). The two groups of scientists did not have a significant association with names predicted to be in Other categories (_P_ = `r get_p(3, 'p.value')`).

